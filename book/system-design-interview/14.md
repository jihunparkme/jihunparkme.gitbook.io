---
description: 대규모 시스템 설계 기초 14장을 요약한 내용입니다.
---

2020년에 조사된 놀라운 통계 자료를 먼저 살펴보자.

- 월간 능동 사용자 수: 2십 억 (2billion)
- 매일 재생되는 비디오 수: 5십 억 (5billion)
- 미국 성인 가운데 73%가 유튜브 이용
- 5천만 명의 창작자
- 유튜브의 광고 수입은 2018 -> 2019 150억 달러로 36% 증가
- 모바일 인터넷 트래픽 가운데 37%를 유튜브가 점유
- 80개의 언어로 이용 가능

**Reference**

- [YouTube by the Numbers](https://www.omnicoreagency.com/youtube-statistics/)
- [YouTube Demographics](https://blog.hubspot.com/marketing/youtube-demographics)

# 1단계: 문제 이해 및 설계 범위 확정

유튜브는 비디오 재생 말고도 댓글, 공유, 좋아요, 재생목록, 구독 등 많은 기능을 제공하므로 적절한 설계 범위 측정이 필요하다.

- 중요 기능은 비디오 업로드, 시청 기능
- 모바일 앱, 웹 브라우저, 스마트 TV 지원
- 일간 능동 상요자 수는 5백만(5million)
- 사용자의 평균 소비 시간은 30분
- 다국어 지원
- 현존하는 비디오 종류와 해상도 대부분을 지원
- 암호화 지원
- 비디오 크기는 최대 1GB로 제한
- 클라우드 서비스 활용

아래 기능을 갖춘 설계에 초점

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 가능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 안정성
- 모바일 앱, 웹 브라우저, 스마트 TV 지원

**개략적 규모 측정**

- 일간 능동 사용자(DAU, Daily Activie User) 수는 5백만(5million)
- 한 사용자는 하루에 평균 5개의 비디오 시청
- 10% 사용자가 하루에 1비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장용량 = 5백만 x 10% x 300MB = 150TB
- CDN 비용(아마존 사용시) = 5백만 x 5비디오 x 0.3GB x $0.02 = $150,000

CDN을 통해 비디오를 서비스하면 비용이 엄청나므로 비용 절감 대안이 필요하다.

# 2단계: 개략적 설계안

개략적으로 설계할 시스템은 세 개 컴포넌트로 구성된다.

**단말(client)**
- 컴퓨터, 모바일, 스마트 TV를 통해 유튜브를 시청할 수 있다.
  
**CDN**
- 비디오는 CDN에 저장
- 재생 버튼을 누르면 CDN으로부터 스트리밍

**API 서버**
- 비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리
- 피드 추천, 비디오 업로드 URL 생성, 메타데이터 DB, 캐시 갱신, 사용자 가입 등

## 비디오 업로드 절차

비디오 업로드 절차의 개략적 설계안

<figure><img src="../../.gitbook/assets/system-design-interview/14-4.png" alt=""><figcaption></figcaption></figure>

- `사용자`: 컴퓨터나 모바일, 스마트 TV를 통해 유튜브를 시청하는 이용자
- `로드밸런서`: API 서버 각각으로 고르게 요청을 분산하는 역할 담당
- `API` 서버: 비디오 스트리밍을 제외한 다른 모든 요청 처리
- `메타데이터 데이터베이스`: 비디오의 메타데이터 보관
  - 샤딩, 다중화를 적용하여 성능 및 가용성 요구사항 충족
- `메타데이터 캐시`: 성능 향상을 위해 비디오 메타데이터와 사용자 객체 캐시
- `원본 저장소`: 원본 비디오를 보관할 대형 이진 파일 저장소(BLOB)
- `트랜스코딩 서버`: 비디오 트랜스코딩은 비디오 인코딩이라 부르기도 하는 절차
  - 비디오의 포맷을 변환하는 절차
  - 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림 제공을 위해 필요
- `트랜스코딩 비디오 저장소`: 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- `CDN`: 비디오를 캐시하는 역할을 담당
  - 사용자가 재생 버튼을 누르면 비디오 스트리밍은 CDN을 통해 처리
- `트랜스코딩 완료 큐`: 비디오 트랜스코딩 완료 이벤트를 보관할 메시지 큐
- `트랜스코딩 완료 핸들러`: 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들

비디오 업로드는 아래 두 프로세스가 병렬적으로 수행된다.
- a. 비디오 업로드
- b. 비디오 메타데이터 갱신
  - 비디오 URL, 크기, 해상도, 포맷, 사용자 정보 포함

### a. 비디오 업로드

<figure><img src="../../.gitbook/assets/system-design-interview/14-4.png" alt=""><figcaption></figcaption></figure>

- (1) 비디오를 원본 저장소에 업로드
- (2) 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩 시작
- (3) 트랜스 코딩이 완료되면 아래 두 절차가 병렬적으로 수행
  - (3a) 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
  - (3b) 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 삽입
    - (3a.1) 트랜스코딩이 끝난 비디오를 CDN에 올린다.
    - (3b.1) 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다.
    - (3b.1.a)(3b.1.b) 완료 핸들러가 메타데이터 데이터베이스와 캐시를 갱신
- (4) API 서버가 단말에게 비디오 업로드가 끝나서 스트리밍 준비가 되었음을 알린다.

### b. 비디오 메타데이터 갱신

원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.
- 메타데이터에는 파일 이름, 크기, 포맷 등의 정보가 들어 있다.
- 이 정보로 메타데이터 캐시와 데이터베이스를 업데이트한다.

## 비디오 스트리밍 절차

# 3단계: 상세 설계

## 비디오 트랜스코딩

## 유향 비순환 그래프(DAG) 모델

## 비디오 트랜스코딩 아키텍처

## 시스템 최적화

# 4단계: 마무리