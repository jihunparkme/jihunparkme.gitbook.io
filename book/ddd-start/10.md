---
description: 도메인 주도 개발 시작하기 10장을 요약한 내용입니다.
---

# 시스템 간 강결합 문제

**도메인 객체에서 환불 기능을 실행**

환불 기능을 제공하는 도메인 서비스를 파라미터로 전달받고 취소 도메인 기능에서 도메인 서비스를 실행하게 된다.

```java
public class Order {
    ...
    // 외부 서비스를 실행하기 위해 도메인 서비스르르 파라미터로 전달받음
    public void cancel(RefundService refundService) {
        // 주문 로직
        verifyNotYetShipped();
        this.state = OrderState.CANCELED;
        
        // 결제 로직
        this.refundStatus = State.REFUND_STARTED;
        try {
            // 외부 서비스 성능에 직접 영향을 받는다.
            refundService.refund(getPaymentId());
            this.refundStatus = State.REFUND_COMPLETED;
        } catch(Exception ex) {
            ...
        }
    }
    ...
}
```

도메인 객체에 서비스를 전달할 시 문제점.

주문 로직과 결제 로직이 섞이면서 **설계상 문제**가 나타날 수 있다.
- 환불 기능이 변경되면 Order도 영향을 받게 된다.
- 주문 도메인 객체의 코드를 결제 도메인 때문에 변경할지 모르는 상황은 좋지 않다.

기능을 추가할 때도 문제가 발생한다.
- 기능을 추가할 때마다 서비스 파라미터가 함께 추가되고, 다른 로직이 더 많이 섞이고, 트랜잭션 처리가 복잡해진다.
- 영향을 주는 외부 서비스가 증가하게 된다.

**응용 서비스에서 환불 기능 실행**

```java
public class CancelOrderService {
    private RefundService refindService;

    @Transactional
    public void cancel(OrderNo orderNo) {
        Order order = findOrder(orderNo);
        order.cancel();

        order.refundStart();
        try {
            // 외부 서비스 성능에 직접 영향을 받는다.
            refundService.refund(order.getPaymentId());
            order.refundCompleted();
        } catch(Exception ex) {
            ...
        }
    }
}
```

보통 결제 시스템은 외부에 존재하므로 RefundService는 **외부에 있는 결제 시스템이 제공하는 환불 서비스를 호출**한다.
- 이 때 두 가지 문제가 발생할 수 있다.

**첫 번쨰 문제, 외부 서비스가 정상이 아닐 경우 트랜잭션 처리를 어떻게 할 것인가?**
- 외부의 환불 서비스를 실행하는 과정에서 익센션이 발생하면 환불에 실패했으므로 주문 취소 트랜잭션을 롤백하는 것이 맞아 보이지만, 반드시 트랜잭션을 롤백해야 하는 것은 아니다.
- 주무은 취소 상태로 변경하고 환불만 나중에 다시 시도하는 방식으로 처리할 수도 있다.

**두 번째 문제, 성능**
- 환불을 처리하는 외부 시스템의 응답 시간이 길어지면 그 만큼 대기 시간도 길어진다.
- 환불 처리 기능이 30초가 걸리면 주문 취소 기능은 30초만큼 대기 시간이 증가한다
- 외부 서비스 성능에 직접적인 영향을 받게 된다.

...

이러한 문제가 발생하는 이유는 주문 바운디드 컨텍스트와 결제 바운디드 컨텍스트간의 **강결합(high coupling) 때문**이다.
- 강한 결합을 없애기 위해 `이벤트`를 사용할 수 있다.
- 특히 **비동기 이벤트를 사용하면 두 시스템 간의 결합을 크게 낮출 수 있다.**
- 이벤트가 익숙해지면 모든 연동을 이벤트와 비동기로 처리하고 싶을 정도로 강력하고 매력적이다.

## 이벤트 개요






# 11.CQRS